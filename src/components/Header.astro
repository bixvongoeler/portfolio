---
import { siteConfig } from "../config";
import { getVisibleSections } from "../utils/sections";
import MenuIcon from "../icons/menu.svg";
import CloseIcon from "../icons/close.svg";
import SunIcon from "../icons/sun.svg";
import MoonIcon from "../icons/moon.svg";

const sections = getVisibleSections();
---

<header id="header" class="fixed top-0 left-0 right-0 z-50 p-2 sm:p-[clamp(0.5rem,2vw,1rem)]">
    <nav
        class="px-3 sm:px-[clamp(1rem,3vw,2rem)] py-2 sm:py-[clamp(0.5rem,1.5vw,1rem)] bg-white/80 dark:bg-slate-900/80 backdrop-blur-md rounded-2xl shadow-lg border border-gray-200/50 dark:border-slate-700/50"
    >
        <!-- Mobile header -->
        <div class="flex sm:hidden items-center justify-between">
            <button
                id="mobile-menu-toggle"
                type="button"
                aria-label="Toggle menu"
                class="w-9 h-9 flex items-center justify-center rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors duration-200"
            >
                <MenuIcon id="hamburger-icon" class="w-5 h-5" />
                <CloseIcon id="close-icon" class="w-5 h-5 hidden" />
            </button>

            <span class="text-sm font-medium text-gray-700 dark:text-gray-300 lowercase">
                {siteConfig.name.toLowerCase()}
            </span>

            <button
                id="theme-toggle-mobile"
                type="button"
                aria-label="Toggle dark mode"
                class="w-9 h-9 flex items-center justify-center rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors duration-200"
            >
                <SunIcon class="hidden dark:block w-5 h-5" />
                <MoonIcon class="block dark:hidden w-5 h-5" />
            </button>
        </div>

        <!-- Mobile menu (expandable) -->
        <div id="mobile-menu" class="hidden sm:hidden">
            <ul class="flex flex-col gap-2 pt-4 pb-2 border-t border-gray-200/50 dark:border-slate-700/50 mt-2">
                {sections.map((section) => (
                    <li>
                        <a
                            href={`#${section.id}`}
                            data-nav-link={section.id}
                            class="nav-link block py-2 px-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors font-medium"
                        >
                            {section.label}
                        </a>
                    </li>
                ))}
            </ul>
        </div>

        <!-- Desktop header -->
        <div class="hidden sm:flex items-center justify-between">
            <div class="w-[clamp(2rem,4vw,2.5rem)]"></div>

            <ul
                class="flex items-center gap-[clamp(1rem,3vw,2.5rem)] text-[clamp(0.8rem,1.5vw,1rem)] justify-center flex-1"
            >
                {sections.map((section) => (
                    <li>
                        <a
                            href={`#${section.id}`}
                            data-nav-link={section.id}
                            class="nav-link text-gray-700 dark:text-gray-300 hover:text-black dark:hover:text-white transition-all duration-300 font-medium px-2 py-1 rounded-md"
                        >
                            {section.label}
                        </a>
                    </li>
                ))}
            </ul>

            <button
                id="theme-toggle"
                type="button"
                aria-label="Toggle dark mode"
                class="w-[clamp(2rem,4vw,2.5rem)] h-[clamp(2rem,4vw,2.5rem)] flex items-center justify-center rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors duration-200"
            >
                <SunIcon class="hidden dark:block w-[clamp(1rem,2vw,1.25rem)] h-[clamp(1rem,2vw,1.25rem)]" />
                <MoonIcon class="block dark:hidden w-[clamp(1rem,2vw,1.25rem)] h-[clamp(1rem,2vw,1.25rem)]" />
            </button>
        </div>
    </nav>
</header>

<script>
    // Mobile menu toggle
    const menuToggle = document.getElementById("mobile-menu-toggle");
    const mobileMenu = document.getElementById("mobile-menu");
    const hamburgerIcon = document.getElementById("hamburger-icon");
    const closeIcon = document.getElementById("close-icon");

    menuToggle?.addEventListener("click", () => {
        const isOpen = !mobileMenu?.classList.contains("hidden");
        mobileMenu?.classList.toggle("hidden", isOpen);
        hamburgerIcon?.classList.toggle("hidden", !isOpen);
        closeIcon?.classList.toggle("hidden", isOpen);
    });

    // Close menu when clicking a link
    mobileMenu?.querySelectorAll("a").forEach((link) => {
        link.addEventListener("click", () => {
            mobileMenu?.classList.add("hidden");
            hamburgerIcon?.classList.remove("hidden");
            closeIcon?.classList.add("hidden");
        });
    });

    // Theme toggle functionality
    const themeToggle = document.getElementById("theme-toggle");
    const themeToggleMobile = document.getElementById("theme-toggle-mobile");

    const toggleTheme = () => {
        const currentTheme = (window as any).__getTheme();
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        (window as any).__setTheme(newTheme, true);
    };

    themeToggle?.addEventListener("click", toggleTheme);
    themeToggleMobile?.addEventListener("click", toggleTheme);

    // Section scroll highlighting with IntersectionObserver
    const sections = document.querySelectorAll("section[id]");
    const navLinks = document.querySelectorAll(".nav-link");

    const observerOptions = {
        root: null,
        rootMargin: "-20% 0px -60% 0px",
        threshold: 0,
    };

    const setActiveLink = (sectionId: string) => {
        navLinks.forEach((link) => {
            const linkSection = link.getAttribute("data-nav-link");
            if (linkSection === sectionId) {
                link.classList.add("nav-active");
            } else {
                link.classList.remove("nav-active");
            }
        });
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            if (entry.isIntersecting) {
                setActiveLink(entry.target.id);
            }
        });
    }, observerOptions);

    sections.forEach((section) => {
        observer.observe(section);
    });
</script>

<style>
    html {
        scroll-behavior: smooth;
    }

    .nav-link.nav-active {
        color: var(--accent-color);
        background-color: rgba(0, 181, 160, 0.1);
        box-shadow: 0 2px 8px rgba(0, 181, 160, 0.3);
        border-radius: 0.375rem;
    }
</style>
